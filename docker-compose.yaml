version: "3.8"

x-environment: &environment
  REDIS_CACHE_ADDR: db.redis:6379
  REDIS_PUBSUB_ADDR: pubsub.redis:6379
  FORWARDER_DATA_GATEWAY_ADDR: service.data-gateway:8000
  SERVER_HOST: 0.0.0.0

services:
  db.redis:
    image: redis:6.0-alpine
    ports:
      - 6379:6379

  pubsub.redis:
    image: redis:6.0-alpine
    ports:
      - 6389:6379

  service.control-tower:
    build:
      context: .
      dockerfile: ./docker/service.control-tower/Dockerfile
    image: lab-automation/service.control-tower:latest
    depends_on:
      - db.redis
      - pubsub.redis
    env_file:
      - ./services/control-tower/.env
    environment:
      <<: *environment

  service.data-gateway:
    build:
      context: .
      dockerfile: ./docker/service.data-gateway/Dockerfile
    image: lab-automation/service.data-gateway:latest
    depends_on:
      - db.redis
      - pubsub.redis
      - service.control-tower
    env_file:
      - ./services/data-gateway/.env
    environment:
      <<: *environment
      PLUGIN_RIFFYN_CONTROL_TOWER_ADDR: service.control-tower:8000

  service.ot-builder:
    build:
      context: .
      dockerfile: ./docker/service.ot-builder/Dockerfile
    image: lab-automation/service.ot-builder:latest
    depends_on:
      - db.redis
      - pubsub.redis
      - service.control-tower
    ports:
      - 8000:8000
    environment:
      <<: *environment

  service.chibio-relay:
    build:
      context: .
      dockerfile: ./docker/service.chibio-relay/Dockerfile
    image: lab-automation/service.chibio-relay:latest
    depends_on:
      - db.redis
      - pubsub.redis
      - service.control-tower
      - service.data-gateway
      - external.chibio-server
    environment:
      <<: *environment
      MANAGER_CHIBIO_SERVER_ADDR: external.chibio-server:5000
      MANAGER_DEVICE_NAME: ChioBio1
    volumes:
      - ./data:/usr/service/data

  service.tecan-spark-relay:
    build:
      context: .
      dockerfile: ./docker/service.tecan-spark-relay/Dockerfile
    image: lab-automation/service.tecan-spark-relay:latest
    depends_on:
      - db.redis
      - pubsub.redis
      - service.control-tower
      - service.data-gateway
    environment:
      <<: *environment
      MANAGER_DEVICE_NAME: GBSpark
    volumes:
      - ./data:/usr/service/data

  external.chibio-server:
    image: lab-automation/chibio:latest
    ports:
      - 5000:5000
    volumes:
      - ./data:/src/data
